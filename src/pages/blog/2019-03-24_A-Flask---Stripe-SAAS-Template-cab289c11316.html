<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>A Flask + Stripe SAAS Template</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">A Flask + Stripe SAAS Template</h1>
</header>
<section data-field="subtitle" class="p-summary">
Bootstrapped template for Flask and Stripe integration
</section>
<section data-field="body" class="e-content">
<section name="6ff5" class="section section--body section--first"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="7b0b" id="7b0b" class="graf graf--h3 graf--leading graf--title">A Flask + Stripe SAAS Template</h3><h4 name="5361" id="5361" class="graf graf--h4 graf-after--h3 graf--subtitle">Bootstrapped template for Flask and Stripe integration</h4><figure name="3980" id="3980" class="graf graf--figure graf-after--h4"><img class="graf-image" data-image-id="1*naU8AAAU_xrMaURPrxVVaA.png" data-width="963" data-height="686" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/1*naU8AAAU_xrMaURPrxVVaA.png"></figure><p name="9f7d" id="9f7d" class="graf graf--p graf-after--figure">Recently I’ve been working on side projects, away from the large, “enterprisey” code bases that I typically deal with at work. I tried out quite a few different setups since it’s so easy to get caught in a loop, using the same tools, patterns, and ideas over and over within a single project/system you work on. It’s nice to break out of that every once in a while and see other ideas.</p><p name="e846" id="e846" class="graf graf--p graf-after--p">After going through a few frameworks, experimenting with different architecture patterns, and thinking about ways to organize projects I <a href="https://bustererp.com" data-href="https://bustererp.com" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">ended up building a small application called Buster</a> with Flask.</p><p name="8931" id="8931" class="graf graf--p graf-after--p">It’s more like Flask + friends because of the libraries, but you’ll see more about that as you get into this guide.</p><p name="f46c" id="f46c" class="graf graf--p graf-after--p">After I deciding I was going to use Flask, I search around for some direction on basic things like user registration with Stripe subscriptions, running Flask in a container, etc. I needed some direction on building a SAAS application in Flask but didn’t find any guides.</p><p name="5c45" id="5c45" class="graf graf--p graf-after--p">So I wanted to write up what I learned, how I ended up organizing my Flask project, how I integrated it with Stripe.</p><p name="9604" id="9604" class="graf graf--p graf-after--p">I’ll walk you through the python packages I used, how the code is organized, how to run the sample project I created with docker-compose, and how to run a test suite.</p><p name="7a6d" id="7a6d" class="graf graf--p graf-after--p">For this example, we are keeping things simple. There will be a way for Users to register an account with their billing information. This will create a subscription to a single product in Stripe. If the user deletes their account, then it stops their subscription. This is targeted towards a SAAS model with a simple billing plan.</p><h3 name="dc22" id="dc22" class="graf graf--h3 graf-after--p">What’s Covered</h3><ul class="postList"><li name="bbc4" id="bbc4" class="graf graf--li graf-after--h3">Application Tools, Libraries, and Frameworks Used</li><li name="bef0" id="bef0" class="graf graf--li graf-after--li">Getting Setup and Running the Application</li><li name="d7f4" id="d7f4" class="graf graf--li graf-after--li">Code Organization — Container Structures, Bootstrap Files, Authentication, Data Models, Routing and Views, Form Processing, Stripe Integration Requests</li><li name="c39a" id="c39a" class="graf graf--li graf-after--li">Running Tests</li></ul><h3 name="6d48" id="6d48" class="graf graf--h3 graf-after--li">The Tools</h3><p name="aa41" id="aa41" class="graf graf--p graf-after--h3">We are using the following tools, libraries, and frameworks:</p><ul class="postList"><li name="a382" id="a382" class="graf graf--li graf-after--p"><a href="https://github.com/pallets/flask" data-href="https://github.com/pallets/flask" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">Flask</a></li><li name="196e" id="196e" class="graf graf--li graf-after--li"><a href="https://flask-login.readthedocs.io/en/latest/" data-href="https://flask-login.readthedocs.io/en/latest/" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">Flask-Login</a></li><li name="b8b6" id="b8b6" class="graf graf--li graf-after--li"><a href="https://www.sqlalchemy.org/" data-href="https://www.sqlalchemy.org/" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">SQLAlchemy</a></li><li name="982e" id="982e" class="graf graf--li graf-after--li"><a href="https://flask-wtf.readthedocs.io/en/stable/" data-href="https://flask-wtf.readthedocs.io/en/stable/" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">Flask-WTF</a></li><li name="7410" id="7410" class="graf graf--li graf-after--li"><a href="https://flask-migrate.readthedocs.io/en/latest/" data-href="https://flask-migrate.readthedocs.io/en/latest/" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">Flask-Migrate</a></li><li name="eb6a" id="eb6a" class="graf graf--li graf-after--li"><a href="https://gunicorn.org/" data-href="https://gunicorn.org/" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">Gunicorn</a></li><li name="26f4" id="26f4" class="graf graf--li graf-after--li"><a href="https://pypi.org/project/stripe/" data-href="https://pypi.org/project/stripe/" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">Stripe</a></li><li name="0b11" id="0b11" class="graf graf--li graf-after--li"><a href="https://mariadb.org/" data-href="https://mariadb.org/" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">MariaDB</a></li></ul><p name="1646" id="1646" class="graf graf--p graf-after--li">You will see all of the requirements for the application in the <code class="markup--code markup--p-code">requirements.txt</code> file in the repo:</p><figure name="3485" id="3485" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*vACiZJ-jvBow_dTbsevbRg.png" data-width="1702" data-height="792" src="https://cdn-images-1.medium.com/max/800/1*vACiZJ-jvBow_dTbsevbRg.png"></figure><h3 name="2f2a" id="2f2a" class="graf graf--h3 graf-after--figure">What You’ll Need</h3><p name="88c2" id="88c2" class="graf graf--p graf-after--h3">You should only need a couple of things to run the application:</p><ol class="postList"><li name="e7cc" id="e7cc" class="graf graf--li graf-after--p">Docker with <code class="markup--code markup--li-code">docker-compose</code> running on your machine.</li><li name="2d3f" id="2d3f" class="graf graf--li graf-after--li">The ability to <code class="markup--code markup--li-code">git clone</code> the repository.</li></ol><h3 name="a96b" id="a96b" class="graf graf--h3 graf-after--li">Source Code</h3><p name="d85f" id="d85f" class="graf graf--p graf-after--h3">The source code is located at <a href="https://github.com/holdenrehg/sample_flask_stripe_integration" data-href="https://github.com/holdenrehg/sample_flask_stripe_integration" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">https://github.com/holdenrehg/sample_flask_stripe_integration</a> so I recommend using it as a guide while reading through this tutorial.</p><p name="57d6" id="57d6" class="graf graf--p graf-after--p">Or even better, pull down the code yourself, run the application, and test things out!</p><h3 name="c723" id="c723" class="graf graf--h3 graf-after--p">Getting Setup</h3><p name="3681" id="3681" class="graf graf--p graf-after--h3">Here are instructions on getting the sample application running on your machine. All of this information is also outlined in the <code class="markup--code markup--p-code">readme.md</code> file in the repo.</p><p name="df60" id="df60" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">1. Update your hosts file</strong>.</p><p name="65ba" id="65ba" class="graf graf--p graf-after--p">Update your <code class="markup--code markup--p-code">/etc/hosts</code> file by adding the following line:</p><pre name="d9bb" id="d9bb" class="graf graf--pre graf-after--p">0.0.0.0 mystripeapp.local</pre><p name="4940" id="4940" class="graf graf--p graf-after--pre"><strong class="markup--strong markup--p-strong">2. Get the source code</strong></p><p name="7a2b" id="7a2b" class="graf graf--p graf-after--p">Clone down the repository.</p><p name="664d" id="664d" class="graf graf--p graf-after--p">These setup instructions are assuming you clone down the repo as <code class="markup--code markup--p-code">mystripeapp</code> so you may experience issues or have to slightly alter commands if you clone it down as another directory name.</p><figure name="e4af" id="e4af" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*dLoEUbmoPE7eeIZVFeHyHA.png" data-width="1702" data-height="204" src="https://cdn-images-1.medium.com/max/800/1*dLoEUbmoPE7eeIZVFeHyHA.png"></figure><p name="f199" id="f199" class="graf graf--p graf-after--figure"><strong class="markup--strong markup--p-strong">3. Update environment variables</strong></p><p name="6c49" id="6c49" class="graf graf--p graf-after--p">There are a set of environment variables located under <code class="markup--code markup--p-code">mystripeapp/utils/__init__.py</code> that need to be updated before running the application</p><p name="da6c" id="da6c" class="graf graf--p graf-after--p">The only two environment variables that you should need to change to get the application up and running are the stripe token and the stripe product code.</p><figure name="e6bc" id="e6bc" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*xkaBnCvXuXy9JLXfCuMctw.png" data-width="1702" data-height="1196" src="https://cdn-images-1.medium.com/max/800/1*xkaBnCvXuXy9JLXfCuMctw.png"></figure><p name="d218" id="d218" class="graf graf--p graf-after--figure">After updating <code class="markup--code markup--p-code">mystripeapp/utils/__init__.py</code> you will need to add your frontend/public Stripe token to the <code class="markup--code markup--p-code">mystripeapp/ui/views/auth/register.xml</code> file.</p><figure name="5cf7" id="5cf7" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*Ve4iSsYSXS0IVg6KKEPLJQ.png" data-width="1254" data-height="242" src="https://cdn-images-1.medium.com/max/800/1*Ve4iSsYSXS0IVg6KKEPLJQ.png"></figure><p name="20a6" id="20a6" class="graf graf--p graf-after--figure"><strong class="markup--strong markup--p-strong">4. Start up the application</strong></p><p name="e99a" id="e99a" class="graf graf--p graf-after--p">This is going to build the containers and start the Flask application. If you are not using the <code class="markup--code markup--p-code">-d</code> flag then you will see all of the application logs and the database logs. This is helpful for debugging.</p><pre name="828d" id="828d" class="graf graf--pre graf-after--p">$ cd mystripeapp<br>$ docker-compose up</pre><p name="d1f9" id="d1f9" class="graf graf--p graf-after--pre"><strong class="markup--strong markup--p-strong">5. Migrate the database</strong></p><p name="e93e" id="e93e" class="graf graf--p graf-after--p">Make sure to leave the application running before running any migration commands.</p><p name="0880" id="0880" class="graf graf--p graf-after--p">You’ll run these three commands to get started. The database container to mapped to port <code class="markup--code markup--p-code">10404</code> so you can connect to it either from command line using the <code class="markup--code markup--p-code">mysql</code> cli or through a GUI like sequelpro or dbeaver.</p><p name="1109" id="1109" class="graf graf--p graf-after--p">You’ll see the other connection details in the <code class="markup--code markup--p-code">docker-compose.yml</code> file.</p><figure name="43fa" id="43fa" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*x8ARcpcBuTKlh9_zeclnkw.png" data-width="1702" data-height="278" src="https://cdn-images-1.medium.com/max/800/1*x8ARcpcBuTKlh9_zeclnkw.png"></figure><p name="eebb" id="eebb" class="graf graf--p graf-after--figure"><strong class="markup--strong markup--p-strong">6. Access the application</strong></p><p name="d4fb" id="d4fb" class="graf graf--p graf-after--p">Everything should be ready to go now. Open up a browser and navigate to <a href="http://mystripeapp.local:5200" data-href="http://mystripeapp.local:5200" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">http://mystripeapp.local:5200</a> to see if you have access.</p><p name="dff3" id="dff3" class="graf graf--p graf-after--p">Assuming everything is okay, you can start testing the application or dig right into the source code.</p><h3 name="7f0d" id="7f0d" class="graf graf--h3 graf-after--p">Account Flows</h3><h4 name="7bca" id="7bca" class="graf graf--h4 graf-after--h3">Registration</h4><p name="cdbd" id="cdbd" class="graf graf--p graf-after--h4">If you added Stripe tokens properly, then you should be able to easily register a new account.</p><p name="1fdc" id="1fdc" class="graf graf--p graf-after--p">Navigate to <a href="http://mystripeapp.local:5200/register" data-href="http://mystripeapp.local:5200/register" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">http://mystripeapp.local:5200/register</a> and add account details using a test card number from stripe <a href="https://stripe.com/docs/testing#cards" data-href="https://stripe.com/docs/testing#cards" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">https://stripe.com/docs/testing#cards</a>.</p><p name="57a7" id="57a7" class="graf graf--p graf-after--p">After registering a new account, you should see a new Subscription in your Stripe dashboard under Billing &gt; Subscriptions.</p><h4 name="6a10" id="6a10" class="graf graf--h4 graf-after--p">Deletion</h4><p name="7e07" id="7e07" class="graf graf--p graf-after--h4">From the application dashboard at <a href="http://mystripeapp.local:5200/dashboard" data-href="http://mystripeapp.local:5200/dashboard" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">http://mystripeapp.local:5200/dashboard</a> you have the ability to delete an account. When the account is deleted, you will see the subscription go to Cancelled under Billing &gt; Subscriptions in your Stripe dashboard.</p><h3 name="cd71" id="cd71" class="graf graf--h3 graf-after--p">Code Organization</h3><pre name="008c" id="008c" class="graf graf--pre graf-after--h3">.<br>├── docker-compose.yml<br>├── Dockerfile<br>├── migrations<br>├── mystripeapp<br>├── README.md<br>├── requirements.txt<br>├── setup.cfg<br>├── setup.py<br>└── tests</pre><p name="c39c" id="c39c" class="graf graf--p graf-after--pre">Pull up the source code for the project and I’ll walk you through how it was written.</p><p name="eb4f" id="eb4f" class="graf graf--p graf-after--p">I don’t plan on outlining every single aspect of the application, but I will describe each section (how views work, how containers are set up, how routing is performed, how data models are defined, etc.)</p><p name="bea5" id="bea5" class="graf graf--p graf-after--p graf--trailing">This will give you plenty enough information to dig into the code and see some of the nitty-gritty details yourself.</p></div></div></section><section name="ddde" class="section section--body"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h4 name="76f2" id="76f2" class="graf graf--h4 graf--leading">The Containers</h4><p name="b2e1" id="b2e1" class="graf graf--p graf-after--h4">We obviously need somewhere to run the code. So the first step was to structure our containers using the <code class="markup--code markup--p-code">docker-compose.yml</code> file.</p><p name="c126" id="c126" class="graf graf--p graf-after--p">We have 3 different containers:</p><figure name="579b" id="579b" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*vVgKBsg2VluZN6yTptMVzw.png" data-width="1702" data-height="2334" src="https://cdn-images-1.medium.com/max/800/1*vVgKBsg2VluZN6yTptMVzw.png"></figure><p name="7bd9" id="7bd9" class="graf graf--p graf-after--figure"><strong class="markup--strong markup--p-strong">Container #1 — app</strong></p><p name="6c64" id="6c64" class="graf graf--p graf-after--p">Our first container is called <code class="markup--code markup--p-code">app</code> and it contains all of the python and Flask source code to run the application.</p><p name="c5c5" id="c5c5" class="graf graf--p graf-after--p">This container runs the Flask application on start, maps the 5200 port on your local machine to the 5000 port inside of the container, maps the entire project directory inside the container at <code class="markup--code markup--p-code">/mystripeapp</code> , and configures the new hostname <code class="markup--code markup--p-code">mystripeapp.local</code> so that we can mimic how the application will run in production with a real DNS.</p><p name="dbf7" id="dbf7" class="graf graf--p graf-after--p">Take a look at the <code class="markup--code markup--p-code">Dockerfile</code> in the root of the project to see how we are provisioning the server. It’s nothing too complicated. We are essentially just installing all of the <code class="markup--code markup--p-code">apt</code> dependencies, installing all of our <code class="markup--code markup--p-code">pip</code> dependencies from the <code class="markup--code markup--p-code">requirements.txt</code> file, and then running the application using a <code class="markup--code markup--p-code">gunicorn</code> process.</p><p name="8867" id="8867" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">Container #2 — mariadb</strong></p><p name="2858" id="2858" class="graf graf--p graf-after--p">Then we need a place to actually store the data. We are using MariaDB for this. We will not be using any custom <code class="markup--code markup--p-code">Dockerfile</code> for our database containers, so that makes this container even simpler.</p><p name="df5c" id="df5c" class="graf graf--p graf-after--p">Take a look at the environment variables defined in the <code class="markup--code markup--p-code">docker-compose.yml</code> to see credentials for the database. By default, everything is set up when you clone down the repo so you will not need to change any credentials until it’s time to release the application out to a remote staging/production server.</p><p name="4415" id="4415" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">Container #3 — testmariadb</strong></p><p name="28ca" id="28ca" class="graf graf--p graf-after--p graf--trailing">Almost an exact mirror of the MariaDB setup, strictly for the purpose of testing the application. This is a database that our unit tests can use.</p></div></div></section><section name="86ca" class="section section--body"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h4 name="857e" id="857e" class="graf graf--h4 graf--leading">Bootstrap</h4><p name="ef8f" id="ef8f" class="graf graf--p graf-after--h4">Next up, we have to actually run the Flask application. We have the <code class="markup--code markup--p-code">app</code> container which attempts to start the application but if you take a look at the <code class="markup--code markup--p-code">Dockerfile</code> for the container, it’s expecting a Flask application to be started up from <code class="markup--code markup--p-code">mystripeapp.bootstrap:app</code> :</p><figure name="830a" id="830a" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*1xn4U0vQV86NPzBfKrvHyA.png" data-width="1702" data-height="278" src="https://cdn-images-1.medium.com/max/800/1*1xn4U0vQV86NPzBfKrvHyA.png"></figure><p name="e2c5" id="e2c5" class="graf graf--p graf-after--figure">So take a look at <code class="markup--code markup--p-code">mystripeapp/bootstrap.py</code> and you’ll see all of the code to initialize the Flask app.</p><figure name="13fa" id="13fa" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*5dmREYw0Tb5JVnU3dmW4iw.png" data-width="1682" data-height="3692" src="https://cdn-images-1.medium.com/max/800/1*5dmREYw0Tb5JVnU3dmW4iw.png"></figure><p name="d2fc" id="d2fc" class="graf graf--p graf-after--figure">We have a few things going on here. Let’s break it down into pieces.</p><p name="92af" id="92af" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">__main__</strong></p><p name="aeaa" id="aeaa" class="graf graf--p graf-after--p">The bootstrap file is broken out into a few different structures just to try to provide a little bit of organization, but the final code that is actually responsible for starting up the application is at the bottom of the file.</p><p name="a1a5" id="a1a5" class="graf graf--p graf-after--p">Here we generate a <code class="markup--code markup--p-code">Flask</code> app variable, initialize our database connection via a <code class="markup--code markup--p-code">SQLAlchemy</code> object, prep the application for database migrations via the <code class="markup--code markup--p-code">Migrate</code> object, and then actually run the application. By default this is going to start up on port 5000 inside the container, which we then map to our local machine as 5200 via the <code class="markup--code markup--p-code">docker-compose.yml</code> file.</p><figure name="7ce3" id="7ce3" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*wb3gOXeoOkIMVRKJwV29-w.png" data-width="1702" data-height="388" src="https://cdn-images-1.medium.com/max/800/1*wb3gOXeoOkIMVRKJwV29-w.png"></figure><p name="ac47" id="ac47" class="graf graf--p graf-after--figure"><strong class="markup--strong markup--p-strong">start</strong></p><p name="3776" id="3776" class="graf graf--p graf-after--p">The <code class="markup--code markup--p-code">start</code> function is in charge of generating our application <code class="markup--code markup--p-code">Flask</code> object and applying configurations.</p><figure name="465b" id="465b" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*U6NB5zPB4Bzin_Fs6V5sLQ.png" data-width="1702" data-height="388" src="https://cdn-images-1.medium.com/max/800/1*U6NB5zPB4Bzin_Fs6V5sLQ.png"></figure><p name="3c71" id="3c71" class="graf graf--p graf-after--figure">Here are the configurations that we care about for this application:</p><ol class="postList"><li name="e225" id="e225" class="graf graf--li graf-after--p">The database connection (host, database name, username, password, port).</li><li name="c256" id="c256" class="graf graf--li graf-after--li">The application <code class="markup--code markup--li-code">SERVER_NAME</code> or url.</li><li name="0e2e" id="0e2e" class="graf graf--li graf-after--li">Paths for templates and views that we’ll render with jinja2.</li><li name="0807" id="0807" class="graf graf--li graf-after--li">Initializing the authentication/session system for login.</li><li name="adc4" id="adc4" class="graf graf--li graf-after--li">Configuring an application logger.</li></ol><p name="68f6" id="68f6" class="graf graf--p graf-after--li"><strong class="markup--strong markup--p-strong">BaseModel</strong></p><p name="33d3" id="33d3" class="graf graf--p graf-after--p">And finally, in the bootstrap, we have a <code class="markup--code markup--p-code">BaseModel</code> class. This is the class that all database models inherit from. This allows us to have common logic across all database models.</p><p name="f97e" id="f97e" class="graf graf--p graf-after--p">For this application, we just have a primary <code class="markup--code markup--p-code">id</code> column because every table should have a primary key, and then a <code class="markup--code markup--p-code">created_at</code> column which gets populated when the specific record is inserted into the table.</p><figure name="a39a" id="a39a" class="graf graf--figure graf-after--p graf--trailing"><img class="graf-image" data-image-id="1*uKUabKomDFEotu9vX8esXg.png" data-width="1702" data-height="938" src="https://cdn-images-1.medium.com/max/800/1*uKUabKomDFEotu9vX8esXg.png"></figure></div></div></section><section name="6b04" class="section section--body"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h4 name="2463" id="2463" class="graf graf--h4 graf--leading">Authentication</h4><p name="8ee2" id="8ee2" class="graf graf--p graf-after--h4">All of the authentication in the application is handled by the <code class="markup--code markup--p-code">Flask-Login</code> library, which makes things easy.</p><p name="71fa" id="71fa" class="graf graf--p graf-after--p">To get this up and running, I only had to do a few things:</p><ol class="postList"><li name="0f9a" id="0f9a" class="graf graf--li graf-after--p">Initialize the <code class="markup--code markup--li-code">LoginManager</code> class in our <code class="markup--code markup--li-code">bootstrap.py</code> file.</li><li name="f386" id="f386" class="graf graf--li graf-after--li">Define a <code class="markup--code markup--li-code">load_user</code> function in our <code class="markup--code markup--li-code">auth.py</code> file.</li><li name="d006" id="d006" class="graf graf--li graf-after--li">Add <code class="markup--code markup--li-code">UserMixin</code> to our <code class="markup--code markup--li-code">User</code> data model</li></ol><figure name="3ffb" id="3ffb" class="graf graf--figure graf-after--li"><img class="graf-image" data-image-id="1*TlaBEWgauNLa5gpEhw892A.png" data-width="1254" data-height="204" src="https://cdn-images-1.medium.com/max/800/1*TlaBEWgauNLa5gpEhw892A.png"></figure><figure name="5922" id="5922" class="graf graf--figure graf-after--figure"><img class="graf-image" data-image-id="1*tR4gdeRmE6rtkaVfEZT87g.png" data-width="1254" data-height="792" src="https://cdn-images-1.medium.com/max/800/1*tR4gdeRmE6rtkaVfEZT87g.png"></figure><figure name="d0bf" id="d0bf" class="graf graf--figure graf-after--figure graf--trailing"><img class="graf-image" data-image-id="1*AW-yc0p1dq1kak55l6ODQw.png" data-width="1254" data-height="352" src="https://cdn-images-1.medium.com/max/800/1*AW-yc0p1dq1kak55l6ODQw.png"></figure></div></div></section><section name="d64d" class="section section--body"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h4 name="c5ed" id="c5ed" class="graf graf--h4 graf--leading">Data Models</h4><p name="d0ca" id="d0ca" class="graf graf--p graf-after--h4">For this project, things are simple compared to most applications. We only have a single table which is stored in the <code class="markup--code markup--p-code">mystripeapp/models.py</code> file.</p><figure name="83c6" id="83c6" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*sEDXElwjbxDDheI3EyMcFg.png" data-width="1702" data-height="2260" src="https://cdn-images-1.medium.com/max/800/1*sEDXElwjbxDDheI3EyMcFg.png"></figure><p name="147b" id="147b" class="graf graf--p graf-after--figure">This is a <code class="markup--code markup--p-code">User</code> class which allows us to register and store users to the application.</p><p name="7b8e" id="7b8e" class="graf graf--p graf-after--p">Essentially in this data model, we are trying to accomplish the following:</p><ul class="postList"><li name="1f2e" id="1f2e" class="graf graf--li graf-after--p">Store basic information about the user like name and email.</li><li name="7503" id="7503" class="graf graf--li graf-after--li">Store encrypted password that they use to log in with.</li><li name="fd3a" id="fd3a" class="graf graf--li graf-after--li graf--trailing">Store Stripe information since all Users will be connected to a Stripe subscription plan.</li></ul></div></div></section><section name="7086" class="section section--body"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h4 name="4275" id="4275" class="graf graf--h4 graf--leading">Routing and Views</h4><p name="7a68" id="7a68" class="graf graf--p graf-after--h4">Both the routing functions and the view rendering that we utilize are built into Flask, so if you aren’t already familiar then read through how Flask uses jinja2 for template rendering.</p><p name="3906" id="3906" class="graf graf--p graf-after--p">For our application specifically, you just need to know a few things:</p><ol class="postList"><li name="c28c" id="c28c" class="graf graf--li graf-after--p">All the routing functions are stored in <code class="markup--code markup--li-code">mystripeapp/routes</code> .</li><li name="7d5b" id="7d5b" class="graf graf--li graf-after--li">All jinja templates are stored in <code class="markup--code markup--li-code">mystripeapp/ui/templates</code> .</li><li name="58f3" id="58f3" class="graf graf--li graf-after--li">All jinja views are stored in <code class="markup--code markup--li-code">mystripeapp/ui/views</code> .</li></ol><p name="0bcb" id="0bcb" class="graf graf--p graf-after--li"><strong class="markup--strong markup--p-strong">Routes</strong></p><p name="6585" id="6585" class="graf graf--p graf-after--p">The routes underneath <code class="markup--code markup--p-code">mystripeapp/routes</code> are broken out into three files to organize routes for guest users, for dashboard users, and then any authentication routes:</p><ul class="postList"><li name="22bf" id="22bf" class="graf graf--li graf-after--p"><code class="markup--code markup--li-code">guest.py</code> — /</li><li name="2e76" id="2e76" class="graf graf--li graf-after--li"><code class="markup--code markup--li-code">auth.py</code> — /login</li><li name="e5cc" id="e5cc" class="graf graf--li graf-after--li"><code class="markup--code markup--li-code">auth.py</code> — /register</li><li name="4762" id="4762" class="graf graf--li graf-after--li"><code class="markup--code markup--li-code">auth.py</code> — /logout</li><li name="5892" id="5892" class="graf graf--li graf-after--li"><code class="markup--code markup--li-code">dashboard.py</code> — /dashboard</li><li name="02ae" id="02ae" class="graf graf--li graf-after--li"><code class="markup--code markup--li-code">dashboard.py</code> — /account/delete</li></ul><p name="832f" id="832f" class="graf graf--p graf-after--li">If you take a look at any of the simpler routing functions, such as the landing page, you’ll see the use of the <code class="markup--code markup--p-code">render_template</code> function.</p><figure name="4358" id="4358" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*hJpB6W_2Jr6CSFT5mQIaxA.png" data-width="1702" data-height="718" src="https://cdn-images-1.medium.com/max/800/1*hJpB6W_2Jr6CSFT5mQIaxA.png"></figure><p name="76d8" id="76d8" class="graf graf--p graf-after--figure">So when a user navigates to the route <a href="http://mystripeapp.local:5200/" data-href="http://mystripeapp.local:5200/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">http://mystripeapp.local:5200/</a> then our application runs the <code class="markup--code markup--p-code">welcome</code> function, which grabs the html sitting at <code class="markup--code markup--p-code">views/landing.html</code> and serves it to the frontend.</p><p name="a7d0" id="a7d0" class="graf graf--p graf-after--p">This should be straightforward, as long as you take a look at the <code class="markup--code markup--p-code">bootstrap.py</code> and see where we are configuring Flask to say that all of our templates/views are stored at <code class="markup--code markup--p-code">mystripeapp/ui</code> . This means that the parameters passed to functions like<code class="markup--code markup--p-code">render_template</code> are always relative to the <code class="markup--code markup--p-code">mystripeapp/ui</code> directory.</p><p name="f3a4" id="f3a4" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">View Structure</strong></p><p name="d23b" id="d23b" class="graf graf--p graf-after--p">All views in the application currently inherit from a single <code class="markup--code markup--p-code">base.py</code> template file that provides the generic <code class="markup--code markup--p-code">&lt;head/&gt;</code> data for the application.</p><figure name="491b" id="491b" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*Ziq-b2r40Rr6o3dHAx3XHA.png" data-width="1254" data-height="1196" src="https://cdn-images-1.medium.com/max/800/1*Ziq-b2r40Rr6o3dHAx3XHA.png"></figure><figure name="3e57" id="3e57" class="graf graf--figure graf-after--figure"><img class="graf-image" data-image-id="1*xgoninn9RU68RhIhxnp_2Q.png" data-width="1702" data-height="1746" src="https://cdn-images-1.medium.com/max/800/1*xgoninn9RU68RhIhxnp_2Q.png"></figure><p name="270c" id="270c" class="graf graf--p graf-after--figure">Within each view, you will also see different directives that are provided by jinja. When the <code class="markup--code markup--p-code">render_template</code> function is called in our routes, the code such as <code class="markup--code markup--p-code">{{ user.name }}</code> is evaluated as python server-side before getting served to the frontend.</p><p name="450a" id="450a" class="graf graf--p graf-after--p">For a simple application like this, we just have a few views:</p><ul class="postList"><li name="2079" id="2079" class="graf graf--li graf-after--p"><code class="markup--code markup--li-code">dashboard.html</code></li><li name="23f1" id="23f1" class="graf graf--li graf-after--li"><code class="markup--code markup--li-code">landing.html</code></li><li name="5ae9" id="5ae9" class="graf graf--li graf-after--li"><code class="markup--code markup--li-code">auth/login.html</code></li><li name="76be" id="76be" class="graf graf--li graf-after--li graf--trailing"><code class="markup--code markup--li-code">auth/register.html</code></li></ul></div></div></section><section name="659b" class="section section--body"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h4 name="2809" id="2809" class="graf graf--h4 graf--leading">Forms</h4><p name="8b2e" id="8b2e" class="graf graf--p graf-after--h4">We are using <code class="markup--code markup--p-code">Flask-WTF</code> which is an extension on top of the form system that is already provided in Flask. It makes form processing very easy.</p><p name="02ec" id="02ec" class="graf graf--p graf-after--p">All forms in the system are defined in the same place. Since they relate nearly 1 to 1 with inputs/forms on the frontend, they are defined under <code class="markup--code markup--p-code">mystripeapp/ui/forms</code> .</p><p name="9fd7" id="9fd7" class="graf graf--p graf-after--p">Let’s take a look at the <code class="markup--code markup--p-code">RegisterForm</code> class:</p><figure name="3688" id="3688" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*rZ3pp3AU6Gj5VROxiBmMiw.png" data-width="1682" data-height="3434" src="https://cdn-images-1.medium.com/max/800/1*rZ3pp3AU6Gj5VROxiBmMiw.png"></figure><p name="8259" id="8259" class="graf graf--p graf-after--figure">You can see that every form is defined as a class that inherits the general <code class="markup--code markup--p-code">FlaskForm</code> class.</p><p name="9e09" id="9e09" class="graf graf--p graf-after--p">Each form has a list of attributes for the information that the form is expected to contain. In the case of the <code class="markup--code markup--p-code">RegisterForm</code> we have:</p><ul class="postList"><li name="d294" id="d294" class="graf graf--li graf-after--p">name</li><li name="2511" id="2511" class="graf graf--li graf-after--li">email</li><li name="c112" id="c112" class="graf graf--li graf-after--li">password</li><li name="e257" id="e257" class="graf graf--li graf-after--li">stripeToken</li><li name="0ee0" id="0ee0" class="graf graf--li graf-after--li">lastFour</li></ul><p name="19d2" id="19d2" class="graf graf--p graf-after--li">Then we have a <code class="markup--code markup--p-code">validate</code> function which validates the data within the form. If you do not override <code class="markup--code markup--p-code">validate</code> then it performs default logic based on the type of fields and the <code class="markup--code markup--p-code">validators</code> listed on the field.</p><p name="c9f9" id="c9f9" class="graf graf--p graf-after--p">For example, we have a password field which must be at least 8 characters long but not more than 64 characters long. The <code class="markup--code markup--p-code">FlaskForm</code> will handle this logic out of the box.</p><figure name="05b2" id="05b2" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*U-tbIM309AajZZWcdUUIRA.png" data-width="1288" data-height="388" src="https://cdn-images-1.medium.com/max/800/1*U-tbIM309AajZZWcdUUIRA.png"></figure><p name="8f74" id="8f74" class="graf graf--p graf-after--figure">The <code class="markup--code markup--p-code">RegisterForm</code> just needs to provide some additional logic to ensure that there are no accounts being created with duplicate email addresses.</p><p name="99a8" id="99a8" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">The Form Interface</strong></p><p name="c697" id="c697" class="graf graf--p graf-after--p">Our html form will look like a fairly standard form. There are no hard requirements to get the form to work with the <code class="markup--code markup--p-code">FlaskForm</code> except that the input <code class="markup--code markup--p-code">name</code> attributes must match the attributes defined on the form object.</p><figure name="6ff3" id="6ff3" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*cdh-kyoj67JRH1HsFhGnBA.png" data-width="1682" data-height="2664" src="https://cdn-images-1.medium.com/max/800/1*cdh-kyoj67JRH1HsFhGnBA.png"></figure><p name="7975" id="7975" class="graf graf--p graf-after--figure"><strong class="markup--strong markup--p-strong">The Form Routing</strong></p><p name="5149" id="5149" class="graf graf--p graf-after--p">Then the final step in handling the form processing is the route. This is the glue that connects together the interface and the form object.</p><p name="687d" id="687d" class="graf graf--p graf-after--p">For registration, whenever a user posts the registration form it hits the route <code class="markup--code markup--p-code">/register</code> as a <code class="markup--code markup--p-code">POST</code> request. Our route function just has to initialize our <code class="markup--code markup--p-code">RegisterForm</code> object, call the <code class="markup--code markup--p-code">validate_on_submit()</code> function, and then handle the success or failure.</p><p name="e071" id="e071" class="graf graf--p graf-after--p">If the validation succeeds, then we can actually create a new <code class="markup--code markup--p-code">User</code> object, send an API request to Stripe, log the user in, and redirect them to their dashboard.</p><p name="29f0" id="29f0" class="graf graf--p graf-after--p">If the validation fails, then we can redirect back to the form and display the errors to the user. Some of this is magically handled by Flask and Flask-WTF.</p><figure name="f297" id="f297" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*8a4G8NqQ9JSNJFjJ_SZ9rQ.png" data-width="1702" data-height="1086" src="https://cdn-images-1.medium.com/max/800/1*8a4G8NqQ9JSNJFjJ_SZ9rQ.png"></figure><h4 name="5c76" id="5c76" class="graf graf--h4 graf-after--figure">Stripe Integration</h4><p name="5bd2" id="5bd2" class="graf graf--p graf-after--h4">The application only has to handle two different request scenarios for Stripe via the API.</p><p name="7406" id="7406" class="graf graf--p graf-after--p">One request to create a new customer/subscription when a new user registers.</p><p name="360c" id="360c" class="graf graf--p graf-after--p">Another request to cancel the user subscription when they delete their account.</p><p name="e6fe" id="e6fe" class="graf graf--p graf-after--p">Both of these are handled through the <code class="markup--code markup--p-code">stripe</code> python package that can be installed from pypi. The <code class="markup--code markup--p-code">RegisterForm</code> is a good example of how to make requests to Stripe.</p><figure name="c224" id="c224" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*MNOm-m1LF3grbEzYTTSeHg.png" data-width="1702" data-height="938" src="https://cdn-images-1.medium.com/max/800/1*MNOm-m1LF3grbEzYTTSeHg.png"></figure><p name="c52e" id="c52e" class="graf graf--p graf-after--figure graf--trailing">All we need to do is assign the api key from our environment variables, call <code class="markup--code markup--p-code">stripe.Customer.create(...)</code> and then call <code class="markup--code markup--p-code">stripe.Subscription.create(...)</code> after a user registers for the system.</p></div></div></section><section name="4a49" class="section section--body"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="7941" id="7941" class="graf graf--h3 graf--leading">Running Tests</h3><p name="aed6" id="aed6" class="graf graf--p graf-after--h3">The final thing to go over is how to run unit tests.</p><p name="eeca" id="eeca" class="graf graf--p graf-after--p">I’m sure that you noticed at the top of this article that we have to typically run commands inside of the container. So we end up doing things like <code class="markup--code markup--p-code">docker exec -it $(docker ps -q --filter mystripe_app) {command}</code> instead of just running the command directly on our machine.</p><p name="3440" id="3440" class="graf graf--p graf-after--p">The same applies for running tests. With Docker we do not have to deal with keeping all of the dependencies installed directly on our machine, so we will want to run the tests from within the container where the unit tests have access to all of the dependencies and the application source.</p><p name="c9fe" id="c9fe" class="graf graf--p graf-after--p">That is why we are passing a container id to the <code class="markup--code markup--p-code">setup.py</code> command below.</p><figure name="4380" id="4380" class="graf graf--figure graf-after--p graf--trailing"><img class="graf-image" data-image-id="1*t9xDb228THptBNTFbVtrYA.png" data-width="1702" data-height="204" src="https://cdn-images-1.medium.com/max/800/1*t9xDb228THptBNTFbVtrYA.png"></figure></div></div></section><section name="2e6b" class="section section--body section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="f4e6" id="f4e6" class="graf graf--h3 graf--leading">Thanks For Reading</h3><p name="1dfa" id="1dfa" class="graf graf--p graf-after--h3">There’s a lot more to cover with writing an application like this, but I hope this helps get some devs started with building Flask applications that integrate with Stripe or just a simple SAAS application in general.</p><p name="7341" id="7341" class="graf graf--p graf-after--p"><a href="https://twitter.com/reedrehg" data-href="https://twitter.com/reedrehg" class="markup--anchor markup--p-anchor" rel="nofollow noopener nofollow noopener noopener" target="_blank">Follow me on Twitter</a> for random thoughts and articles about python and odoo development. Or <a href="https://medium.com/@reedrehg" data-href="https://medium.com/@reedrehg" class="markup--anchor markup--p-anchor" target="_blank">follow me directly here at Medium</a> to stay up to date on my dev articles.</p><p name="0800" id="0800" class="graf graf--p graf-after--p graf--trailing">Check out my <a href="https://bustererp.com" data-href="https://bustererp.com" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">new project called Buster</a> and let me know your thoughts.</p></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@reedrehg" class="p-author h-card">Holden Rehg</a> on <a href="https://medium.com/p/cab289c11316"><time class="dt-published" datetime="2019-03-24T16:40:12.155Z">March 24, 2019</time></a>.</p><p><a href="https://medium.com/@reedrehg/a-flask-stripe-saas-template-cab289c11316" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on October 31, 2020.</p></footer></article></body></html>