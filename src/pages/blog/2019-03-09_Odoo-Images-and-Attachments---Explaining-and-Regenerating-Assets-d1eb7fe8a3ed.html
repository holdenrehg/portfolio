<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Odoo Images and Attachments‚Ää‚Äî‚ÄäExplaining and Regenerating Assets</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Odoo Images and Attachments‚Ää‚Äî‚ÄäExplaining and Regenerating Assets</h1>
</header>
<section data-field="subtitle" class="p-summary">
How do assets and bundles actually work
</section>
<section data-field="body" class="e-content">
<section name="dad8" class="section section--body section--first"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="9431" id="9431" class="graf graf--h3 graf--leading graf--title">Odoo Images and Attachments‚Ää‚Äî‚ÄäExplaining and Regenerating Assets</h3><h4 name="e4bc" id="e4bc" class="graf graf--h4 graf-after--h3 graf--subtitle">How do assets and bundles actually¬†work</h4><p name="1727" id="1727" class="graf graf--p graf-after--h4">If you have ever manually moved a filestore from one site to another, or migrated a database without the filestore, then you‚Äôve probably had to deal with failing or missing assets.</p><p name="26c9" id="26c9" class="graf graf--p graf-after--p">It‚Äôs not obvious how assets are stored and served within the Odoo system. There is no manual compilation process like you would expect coming from frontend utilities like <code class="markup--code markup--p-code">npm</code>¬†, <code class="markup--code markup--p-code">webpack</code>¬†, or even a simpler <code class="markup--code markup--p-code">sass --watch</code> process.</p><p name="3333" id="3333" class="graf graf--p graf-after--p">As developers, when we are writing stylesheets or javascript we just reload the page and everything has been minified and concatenated into these large asset bundles. Automagically. üéÜ</p><p name="15bb" id="15bb" class="graf graf--p graf-after--p">I‚Äôm going to try to reveal a little bit of the magic going on behind the scenes and some tricks for regenerating assets bundles.</p><h3 name="5f6b" id="5f6b" class="graf graf--h3 graf-after--p">Viewing the¬†bundles</h3><p name="8191" id="8191" class="graf graf--p graf-after--h3">Open up developer tools on any Odoo instance. In the <code class="markup--code markup--p-code">&lt;head/&gt;</code> you won‚Äôt see a ton of <code class="markup--code markup--p-code">link</code> or <code class="markup--code markup--p-code">script</code> tags from all of the different modules (assuming you are not in developer mode). You will just see a few compiled files.</p><figure name="c452" id="c452" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*nYxKkm_-EHvtcKxtMAq0ww.png" data-width="1285" data-height="789" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/1*nYxKkm_-EHvtcKxtMAq0ww.png"></figure><p name="8322" id="8322" class="graf graf--p graf-after--figure">They are broken out into a few categories:</p><ul class="postList"><li name="7394" id="7394" class="graf graf--li graf-after--p"><code class="markup--code markup--li-code">web.assets_common</code></li><li name="3122" id="3122" class="graf graf--li graf-after--li"><code class="markup--code markup--li-code">web.assets_backend</code></li><li name="2d95" id="2d95" class="graf graf--li graf-after--li"><code class="markup--code markup--li-code">web_editor.summernote</code></li><li name="16cb" id="16cb" class="graf graf--li graf-after--li"><code class="markup--code markup--li-code">web_editor.assets_editor</code></li></ul><p name="4381" id="4381" class="graf graf--p graf-after--li">And when you open up any of these files, they are an aggregated set of assets across multiple modules. They aren‚Äôt completely abstracted though. You can still see paths to where the assets came from.</p><p name="b510" id="b510" class="graf graf--p graf-after--p">This is how all of the assets are served up to Odoo when you are accessing the site as a normal, non-developer mode user. We‚Äôll get into why these are like this, but as a developer, you should always expect the assets to be compiled into these large, minified files by default.</p><figure name="c1d1" id="c1d1" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*ROhmkiVzAnlk1bl2jiJDUA.png" data-width="1558" data-height="1154" src="https://cdn-images-1.medium.com/max/800/1*ROhmkiVzAnlk1bl2jiJDUA.png"></figure><h3 name="1619" id="1619" class="graf graf--h3 graf-after--figure">Why are assets¬†bundled</h3><p name="5db3" id="5db3" class="graf graf--p graf-after--h3">I wasn‚Äôt in the room when the creators of Odoo decided to do this, but it‚Äôs most likely for performance and convenience.</p><h4 name="670d" id="670d" class="graf graf--h4 graf-after--p">Performance</h4><p name="fbb2" id="fbb2" class="graf graf--p graf-after--h4">Loading in hundreds and hundreds of assets files isn‚Äôt smart. Odoo isn‚Äôt a small application, so they concatenate everything together server side so that the client only has to load a few files. This makes things faster obviously. Fewer files and less content going over the network.</p><h4 name="ab4c" id="ab4c" class="graf graf--h4 graf-after--p">Convenience</h4><p name="c639" id="c639" class="graf graf--p graf-after--h4">There is a certain convenience about creating your module, defining your assets in xml, writing your css or js, reloading the page, and not having to worry about the bundling process at all. No file watchers, no extra commands to run.</p><p name="0a9e" id="0a9e" class="graf graf--p graf-after--p">I don‚Äôt completely agree with this approach because there‚Äôs too much ‚Äúmagic‚Äù and it‚Äôs not explicit to the developer what‚Äôs going on. If something is implicit then it needs to work 100% of the time. In the case of asset bundles, there are still scenarios where developers have to manually work with them (the reason I‚Äôm writing this article).</p><p name="0fb5" id="0fb5" class="graf graf--p graf-after--p">But I do understand the benefits to this approach, and as a developer as long as you are slightly aware of the inner working, then you‚Äôll be able to handle any scenario.</p><h3 name="fb1d" id="fb1d" class="graf graf--h3 graf-after--p">Revealing a little bit¬†more</h3><p name="eb3d" id="eb3d" class="graf graf--p graf-after--h3">Even though we open up dev tools and see all of those assets compiled, there are built-in utilities in Odoo for getting around that immediately.</p><p name="516a" id="516a" class="graf graf--p graf-after--p">This is where the difference between Developer Mode and Developer Mode with Assets comes in. I‚Äôm sure many users and even some developers have wondered why both of these modes exist.</p><p name="c166" id="c166" class="graf graf--p graf-after--p">Developer Mode leave the assets as is. They continue to perform their default process of concatenation and minification of all assets.</p><p name="46e4" id="46e4" class="graf graf--p graf-after--p">But we‚Äôre going to focus on Developer Tools with Assets. Let‚Äôs go ahead and enable is so that we can see exactly how it affects the asset bundling process. You can enable it one of two ways.:</p><ol class="postList"><li name="19a8" id="19a8" class="graf graf--li graf-after--p">Go to Settings and select ‚ÄúActivate developer mode (with assets)‚Äù</li></ol><p name="e856" id="e856" class="graf graf--p graf-after--li">2. Or add <code class="markup--code markup--p-code">debug=assets</code> to your url parameters.</p><p name="2821" id="2821" class="graf graf--p graf-after--p">Now check out dev tools again:</p><figure name="357d" id="357d" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*d4luX102MHM38Rtfq4prYQ.png" data-width="1557" data-height="1372" src="https://cdn-images-1.medium.com/max/800/1*d4luX102MHM38Rtfq4prYQ.png"></figure><figure name="4a32" id="4a32" class="graf graf--figure graf-after--figure"><img class="graf-image" data-image-id="1*5P5j6sG6a5z2TR9XVb8qpA.png" data-width="1946" data-height="1376" src="https://cdn-images-1.medium.com/max/800/1*5P5j6sG6a5z2TR9XVb8qpA.png"></figure><p name="30ee" id="30ee" class="graf graf--p graf-after--figure">Nothing has been combined into a bundle. Frontend code has not been minified. We are actually now loading in every asset file manually. This obviously hurts performance but is very helpful as a developer. If we need to search css or js, find the original source files from core, extend core frontend code, etc. then we should be working with assets on.</p><h3 name="b7a0" id="b7a0" class="graf graf--h3 graf-after--p">Digging into¬†core</h3><p name="dd22" id="dd22" class="graf graf--p graf-after--h3">Most developers probably understood what I explained above before they read this article. They know that the assets get combined into large asset files like <code class="markup--code markup--p-code">web.assets_backend</code> from an xml template, which they can inherit, stick their own <code class="markup--code markup--p-code">&lt;link/&gt;</code> or <code class="markup--code markup--p-code">&lt;script/&gt;</code> tag in, and then their code gets included on the page.</p><p name="99e8" id="99e8" class="graf graf--p graf-after--p">But I would suspect most developers don‚Äôt understand the full process behind the scenes. If you start digging into core a bit, you can see how these are actually combined into bundles.</p><h4 name="ea06" id="ea06" class="graf graf--h4 graf-after--p">Attachments</h4><p name="6e38" id="6e38" class="graf graf--p graf-after--h4"><code class="markup--code markup--p-code">ir.attachment</code> becomes important since all of these bundles that you see on the frontend are stored as attachment records.</p><p name="922e" id="922e" class="graf graf--p graf-after--p">Looking at the database, we can see the following records:</p><pre name="7efc" id="7efc" class="graf graf--pre graf-after--p">odoo=# select id,name from ir_attachment where name like &#39;/web/content/%%assets_backend%.css%&#39;;<br> id  |                       name<br>-----+---------------------------------------------------<br> 749 | /web/content/749-b02200e/web.assets_backend.0.css<br> 750 | /web/content/750-b02200e/web.assets_backend.1.css<br>(2 rows)</pre><pre name="dba6" id="dba6" class="graf graf--pre graf-after--pre">odoo=# select id,name from ir_attachment where name like &#39;/web/content/%&#39;;<br> id  |                          name<br>-----+---------------------------------------------------------<br> 753 | /web/content/753-b02200e/web.assets_backend.js<br> 754 | /web/content/754-60aed99/web_editor.assets_editor.js<br> 681 | /web/content/681-875e871/web.assets_frontend.0.css<br> 683 | /web/content/683-875e871/web.assets_frontend.js<br> 748 | /web/content/748-78450bf/web.assets_common.0.css<br> 749 | /web/content/749-b02200e/web.assets_backend.0.css<br> 750 | /web/content/750-b02200e/web.assets_backend.1.css<br> 751 | /web/content/751-60aed99/web_editor.assets_editor.0.css<br> 752 | /web/content/752-78450bf/web.assets_common.js<br> 351 | /web/content/351-92b02fe/web_editor.summernote.0.css<br> 355 | /web/content/355-92b02fe/web_editor.summernote.js<br>(11 rows)</pre><p name="5585" id="5585" class="graf graf--p graf-after--pre">Looks familiar. We have all of the same files that we see in dev tools when loading up a page. All of these bundles start with <code class="markup--code markup--p-code">/web/content</code> which makes it simple to search for.</p><p name="f69b" id="f69b" class="graf graf--p graf-after--p">We can even see the exact paths to these files in our filestore.</p><p name="1688" id="1688" class="graf graf--p graf-after--p">So we know that when the client makes the request to the frontend, Odoo is looking at those attachment records, finding the file based on a path in the <code class="markup--code markup--p-code">ir.attachment</code> record, and then serving that file to the frontend.</p><pre name="b562" id="b562" class="graf graf--pre graf-after--p">datas_fname               |                 store_fname<br>--------------------------+-----------------------------------------</pre><pre name="26bf" id="26bf" class="graf graf--pre graf-after--pre">web.assets_backend.0.css  | 13/1373c2eeb8edda69ac37a7ecfa5ba4a908fb94ba</pre><pre name="531d" id="531d" class="graf graf--pre graf-after--pre">web.assets_backend.1.css  | 97/9733c7a9a67906f8ded8d8607155351d8d2881d1</pre><pre name="49be" id="49be" class="graf graf--pre graf-after--pre">(2 rows)</pre><figure name="9380" id="9380" class="graf graf--figure graf-after--pre"><img class="graf-image" data-image-id="1*xXNSqBOhBL5obOnHVCTjFA.png" data-width="1782" data-height="1380" src="https://cdn-images-1.medium.com/max/800/1*xXNSqBOhBL5obOnHVCTjFA.png"></figure><h4 name="66cc" id="66cc" class="graf graf--h4 graf-after--figure">Asset creation and templates</h4><p name="4306" id="4306" class="graf graf--p graf-after--h4">So we know how assets are loaded, via <code class="markup--code markup--p-code">ir.attachment</code> but how do they actually get created? Like I said earlier, automagically.</p><p name="8205" id="8205" class="graf graf--p graf-after--p">These are automatically generated, lazily, on page load.</p><figure name="3dd5" id="3dd5" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*x4xBcI_SH9KXs54mZn2KhQ.png" data-width="1782" data-height="608" src="https://cdn-images-1.medium.com/max/800/1*x4xBcI_SH9KXs54mZn2KhQ.png"></figure><p name="5ecf" id="5ecf" class="graf graf--p graf-after--figure">If you take a look at the <code class="markup--code markup--p-code">web.webclient_bootstrap</code> template, you will see those bundles being loaded via the <code class="markup--code markup--p-code">t-call-assets</code> directive. This directive is the main function that looks at the assets and auto creates them.</p><figure name="6123" id="6123" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*Kc2aKkIkqgpZFnqI-Mi5BA.png" data-width="1782" data-height="1196" src="https://cdn-images-1.medium.com/max/800/1*Kc2aKkIkqgpZFnqI-Mi5BA.png"></figure><p name="5608" id="5608" class="graf graf--p graf-after--figure">The <code class="markup--code markup--p-code">IrQweb</code> class is the one responsive for defining the <code class="markup--code markup--p-code">_compile_directive_call_assets</code> method. This method is linked to the xml <code class="markup--code markup--p-code">t-call-assets</code> directive. Check out the method yourself in core, because it does a lot but in terms of asset generation, the most important part of the method is that it calls <code class="markup--code markup--p-code">_get_asset_nodes</code> which then calls <code class="markup--code markup--p-code">get_asset_bundle</code>¬†.</p><p name="8c96" id="8c96" class="graf graf--p graf-after--p">You can see that <code class="markup--code markup--p-code">get_asset_bundle</code> references the primary class <code class="markup--code markup--p-code">AssetsBundle</code> which is in charge of creating, updating, destroying, and generally managing the asset bundles that we‚Äôve been looking at.</p><p name="1179" id="1179" class="graf graf--p graf-after--p"><code class="markup--code markup--p-code">AssetsBundle</code> is another class that you should take a look at yourself to see all of the different functionality provided. But the main function that we are going to look at is <code class="markup--code markup--p-code">save_attachment</code>¬†.</p><figure name="6e2b" id="6e2b" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*zfHcytSl5u-ZSvrkC4pFIQ.png" data-width="1762" data-height="1894" src="https://cdn-images-1.medium.com/max/800/1*zfHcytSl5u-ZSvrkC4pFIQ.png"></figure><p name="6d6b" id="6d6b" class="graf graf--p graf-after--figure">The <code class="markup--code markup--p-code">save_attachment</code> method creates <code class="markup--code markup--p-code">ir.attachment</code> records based on binary strings generated from bundled content passed in. You will notice that these are always prefixed with <code class="markup--code markup--p-code">/web/content</code> which is why we can search <code class="markup--code markup--p-code">ir.attachment</code> records based on <code class="markup--code markup--p-code">/web/content</code> when looking for bundles generated from core.</p><h4 name="4bc7" id="4bc7" class="graf graf--h4 graf-after--p">The details</h4><p name="54a0" id="54a0" class="graf graf--p graf-after--h4 graf--trailing">There are more details that occur between the XML directive and the <code class="markup--code markup--p-code">save_attachment</code> method so I highly recommend going through the methods to learn a little bit more about the actual concatenation and minification process. That‚Äôs out of scope of this article¬†:)</p></div></div></section><section name="31ca" class="section section--body section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="b69f" id="b69f" class="graf graf--h3 graf--leading">The case for regenerating bundles</h3><p name="c717" id="c717" class="graf graf--p graf-after--h3">Before getting into the process of actually regenerating the bundles, let‚Äôs review the scenarios when bundles need to be regenerated. It‚Äôs not too often, depending on what you do day-to-day.</p><ul class="postList"><li name="2510" id="2510" class="graf graf--li graf-after--p">Migrating a filestore manually to a separate instance, via an <code class="markup--code markup--li-code">scp</code>, <code class="markup--code markup--li-code">ftp</code>¬†, or even just a <code class="markup--code markup--li-code">mv</code> transfer.</li><li name="c62d" id="c62d" class="graf graf--li graf-after--li">Restoring a database from a sql dump without the filestore.</li><li name="7a34" id="7a34" class="graf graf--li graf-after--li">Corrupted assets.</li></ul><h3 name="fa73" id="fa73" class="graf graf--h3 graf-after--li">How to regenerate assets from the¬†GUI</h3><p name="fa65" id="fa65" class="graf graf--p graf-after--h3">If are on Odoo 12.0+ then regenerating asset bundles is simple from the GUI (assuming that you can access the GUI.)</p><ol class="postList"><li name="0d78" id="0d78" class="graf graf--li graf-after--p">Enable developer mode</li><li name="9c06" id="9c06" class="graf graf--li graf-after--li">Open the debug menu from the toolbar</li><li name="5497" id="5497" class="graf graf--li graf-after--li">Select Regenerate Asset Bundles</li></ol><p name="88d6" id="88d6" class="graf graf--p graf-after--li">This runs a JS function called <code class="markup--code markup--p-code">regenerateAssets</code>¬†.</p><figure name="4f35" id="4f35" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*3jpjYZ2DPhIT2HxcClEzzA.png" data-width="1782" data-height="1012" src="https://cdn-images-1.medium.com/max/800/1*3jpjYZ2DPhIT2HxcClEzzA.png"></figure><h3 name="09c9" id="09c9" class="graf graf--h3 graf-after--figure">How to regenerate assets from Odoo¬†Shell</h3><p name="2455" id="2455" class="graf graf--p graf-after--h3">Looking at the JS function above, it‚Äôs not too difficult for us to just manually regenerate the assets ourselves from an <a href="https://medium.com/@reedrehg/run-an-odoo-repl-ipython-prompt-7f10d0d5d824" data-href="https://medium.com/@reedrehg/run-an-odoo-repl-ipython-prompt-7f10d0d5d824" class="markup--anchor markup--p-anchor" target="_blank">Odoo shell instance</a>. If you are on Odoo 11.0 or prior, then this is very helpful since you don‚Äôt have the GUI functions provided in 12.0+.</p><p name="28b2" id="28b2" class="graf graf--p graf-after--p">After deleting the <code class="markup--code markup--p-code">ir.attachment</code> records then you just need to reload the web page, which will call the <code class="markup--code markup--p-code">t-call-assets</code> directive again and regenerate the bundles. Once the page is loaded you can look in the database and see that all of those attachments you just deleted are back.</p><figure name="3774" id="3774" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*0vncKOmCp9oTM8QHVcdlbg.png" data-width="1782" data-height="388" src="https://cdn-images-1.medium.com/max/800/1*0vncKOmCp9oTM8QHVcdlbg.png"></figure><h3 name="846f" id="846f" class="graf graf--h3 graf-after--figure">How to regenerate assets from¬†psql</h3><p name="e216" id="e216" class="graf graf--p graf-after--h3">And finally, we can do the same thing from a <code class="markup--code markup--p-code">psql</code> prompt as well.</p><p name="3712" id="3712" class="graf graf--p graf-after--p">The same applies here as when regenerating from Odoo shell. Reload the web page and the system will recreate the asset bundle attachments.</p><figure name="affb" id="affb" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*Vn_mFhPblRGrTAZd5LQ3dQ.png" data-width="1782" data-height="682" src="https://cdn-images-1.medium.com/max/800/1*Vn_mFhPblRGrTAZd5LQ3dQ.png"></figure><h3 name="ba74" id="ba74" class="graf graf--h3 graf-after--figure">Thanks For¬†Reading</h3><p name="1dfa" id="1dfa" class="graf graf--p graf-after--h3">I hope this was helpful!</p><p name="7341" id="7341" class="graf graf--p graf-after--p"><a href="https://twitter.com/reedrehg" data-href="https://twitter.com/reedrehg" class="markup--anchor markup--p-anchor" rel="nofollow noopener noopener" target="_blank">Follow me on Twitter</a> for random thoughts and articles about Odoo. Or <a href="https://medium.com/@reedrehg" data-href="https://medium.com/@reedrehg" class="markup--anchor markup--p-anchor" target="_blank">follow me directly here at Medium</a> to stay up to date on my dev articles.</p><p name="f323" id="f323" class="graf graf--p graf-after--p graf--trailing">Holden</p></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@reedrehg" class="p-author h-card">Holden Rehg</a> on <a href="https://medium.com/p/d1eb7fe8a3ed"><time class="dt-published" datetime="2019-03-09T18:48:11.439Z">March 9, 2019</time></a>.</p><p><a href="https://medium.com/@reedrehg/odoo-images-and-attachments-explaining-and-regenerating-assets-d1eb7fe8a3ed" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on October 31, 2020.</p></footer></article></body></html>